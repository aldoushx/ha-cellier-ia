views:
  - type: masonry
    path: home-2
    title: Home
    cards:
      - type: entity
        entity: sensor.valeur_totale_du_cellier
        icon: mdi:currency-eur
        name: Valeur EstimÃ©e de la Cave
      - type: entity
        entity: sensor.total_bouteilles_cave
        name: Stock Total
      - type: vertical-stack
        cards:
          - type: markdown
            content: >-
              ### LÃ©gende Confiance IA et MaturitÃ©

              <font size="4" color="#00FF00">â—</font> <b>95-100%</b> : Confiance
              absolue

              <font size="4" color="#228B22">â—</font> <b>90-94%</b> : FiabilitÃ©
              excellente

              <font size="4" color="#CDDC39">â—</font> <b>80-89%</b> : FiabilitÃ©
              bonne

              <font size="4" color="#FF9800">â—</font> <b>60-79%</b> : FiabilitÃ©
              modÃ©rÃ©e

              <font size="4" color="#F44336">â—</font> <b>< 60%</b> :
              VÃ©rification conseillÃ©e


              â³ : Bonification

              ğŸ’ : ApogÃ©e

              ğŸ‚ : DÃ©clin
          - type: entities
            entities:
              - entity: input_text.vin_nom
                name: Nom
                icon: mdi:bottle-wine
              - entity: input_text.vin_annee
                name: AnnÃ©e
                secondary_info: none
                icon: mdi:calendar
              - entity: input_text.vin_couleur
                name: Couleur
                icon: mdi:palette-swatch-variant
              - entity: input_button.recherche_vin
                secondary_info: state
                name: Recherche
                icon: mdi:magnify
            title: Nouveau vin
            grid_options:
              columns: 12
              rows: auto
          - type: vertical-stack
            title: Gestion des Emplacements
            cards:
              - type: entities
                entities:
                  - entity: input_select.selection_vin_a_vider
                    name: Choisir la bouteille Ã  retirer
                    icon: mdi:format-list-bulleted
              - type: button
                name: Vider cet emplacement
                icon: mdi:trash-can
                icon_height: 30px
                style: |
                  ha-card {
                    background-color: var(--error-color);
                    color: white;
                  }
                tap_action:
                  action: call-service
                  service: script.vider_emplacement_cellier
                  confirmation:
                    text: >-
                      ÃŠtes-vous sÃ»r de vouloir retirer ce vin ? Cette action est
                      irrÃ©versible.
              - type: markdown
                title: ğŸ” DÃ©tails du vin sÃ©lectionnÃ©
                content: >
                  {% set selection =
                  states('input_select.selection_vin_a_vider').split(' | ')[0]
                  %} {% if states(selection) != 'Vide' and
                  selection.startswith('sensor.vin') %}
                    **Vin :** {{ state_attr(selection, 'nom').valeur }} ({{ state_attr(selection, 'annee').valeur }})
                    **Couleur :** {{ state_attr(selection, 'couleur').valeur }}
                    **Appellation :** {{ state_attr(selection, 'appellation').valeur }}
                    **CÃ©pages :** {{ state_attr(selection, 'cepages').valeur }}
                    **Note :** â­ {{ state_attr(selection, 'note_moyenne').valeur }} - {{ state_attr(selection, 'note_moyenne')['sites consultes'] }}
                    **Prix moyen :** {{ state_attr(selection, 'prix_moyen').valeur }} - {{ state_attr(selection, 'prix_moyen')['magasins sources'] }}
                    
                    ---

                    **Conseil de garde :** {% if state_attr(selection, 'garde_conseillee') != None %} {{ state_attr(selection, 'garde_conseillee').valeur }} {% else %} Non disponible {% endif %} 
                    **Ã€ boire entre :** {% if state_attr(selection, 'fenetre_consommation') != None %} {{ state_attr(selection, 'fenetre_consommation').valeur }} {% else %} Non disponible {% endif %}
                  {% else %}
                    *Veuillez sÃ©lectionner un emplacement occupÃ© pour voir les dÃ©tails.*
                  {% endif %}
              - show_name: true
                show_icon: true
                type: button
                icon_height: 30px
                name: RÃ©initialiser la cave
                icon: mdi:alert-octagon
                entity: input_button.reinitialiser_toute_la_cave
                tap_action:
                  action: toggle
                  confirmation:
                    text: >-
                      ATTENTION : Cela va effacer les 20 emplacements. Confirmer
                      ?
                hold_action:
                  action: none
      - type: vertical-stack
        visibility:
          - condition: state
            entity: sensor.vin_1
            state_not: Vide
        cards:
          - type: markdown
            content: |
              {% set s = 'sensor.vin_1' %}
              {% if states(s) != 'Vide' and states(s) != 'unknown' %}
                {%- macro get_c(attr) -%}
                  {%- set data = state_attr(s, attr) -%}
                  {%- if data is not none and data.confiance is defined -%}
                    {%- set n = data.confiance | replace('%','') | int -%}
                    {%- if n >= 95 -%}#00FF00{%- elif n >= 90 -%}#228B22{%- elif n >= 80 -%}#CDDC39{%- elif n >= 60 -%}#FF9800{%- else -%}#F44336{%- endif -%}
                  {%- else -%}white{%- endif -%}
                {%- endmacro -%}
                
                {%- set coul = (state_attr(s, 'couleur').valeur | lower) if state_attr(s, 'couleur') else '' -%}
                {%- if 'rouge' in coul -%} {%- set hex_coul = '#8B0000' -%}
                {%- elif 'blanc' in coul -%} {%- set hex_coul = '#F3E5AB' -%}
                {%- elif 'rosÃ©' in coul or 'rose' in coul -%} {%- set hex_coul = '#FFB6C1' -%}
                {%- else -%} {%- set hex_coul = '#707070' -%}
                {%- endif -%}

                {# Logique de l'indicateur d'apogÃ©e MÃ©lange PersonnalisÃ© #}
                {%- set annee_actuelle = now().year -%}
                {%- set apogee_brut = state_attr(s, 'apogee').valeur -%}
                {%- set apogee = apogee_brut | replace(' ','') | regex_findall_index('\d{4}', index=0) | int if apogee_brut is string and '20' in apogee_brut else apogee_brut | int(0) -%}
                
                {%- if apogee == 0 -%}
                  {%- set indic = "" -%}
                {%- elif apogee > annee_actuelle -%}
                  {%- set indic = " â³" -%} {# Sablier : Attente #}
                {%- elif apogee < annee_actuelle -%}
                  {%- set indic = " ğŸ‚" -%} {# Feuille : DÃ©clin #}
                {%- else -%}
                  {%- set indic = " ğŸ’" -%} {# Diamant : ApogÃ©e #}
                {%- endif -%}

                <font size="5" color="{{ hex_coul }}">â—</font>{{ indic }} <font size="4"><b>{{ state_attr(s, 'nom').valeur }}</b></font><br>
                <i>{{ state_attr(s, 'annee').valeur }} - {{ state_attr(s, 'appellation').valeur }}</i>
                â­ <font color="{{ get_c('note_moyenne') }}">{{ state_attr(s, 'note_moyenne').valeur }}</font> - ğŸ’° <font color="{{ get_c('prix_moyen') }}">{{ state_attr(s, 'prix_moyen').valeur }}</font><br>
                <b>Garde :</b> <font color="{{ get_c('garde_conseillee') }}">{{ state_attr(s, 'garde_conseillee').valeur }}</font>
                <b>ApogÃ©e :</b> <font color="{{ get_c('apogee') }}">{{ state_attr(s, 'apogee').valeur }}</font>
              {% else %}
                **Emplacement 1** :
                <font color="gray">*Emplacement Libre*</font>
              {% endif %}
          - type: entities
            entities:
              - entity: input_number.quantite_vin_1
                name: Nombre de bouteilles
                icon: mdi:counter
            show_header_toggle: false
            state_color: false
        grid_options:
          columns: 6
          rows: 8
      - type: vertical-stack
        visibility:
          - condition: state
            entity: sensor.vin_2
            state_not: Vide
        cards:
          - type: markdown
            content: |
              {% set s = 'sensor.vin_2' %}
              {% if states(s) != 'Vide' and states(s) != 'unknown' %}
                {%- macro get_c(attr) -%}
                  {%- set data = state_attr(s, attr) -%}
                  {%- if data is not none and data.confiance is defined -%}
                    {%- set n = data.confiance | replace('%','') | int -%}
                    {%- if n >= 95 -%}#00FF00{%- elif n >= 90 -%}#228B22{%- elif n >= 80 -%}#CDDC39{%- elif n >= 60 -%}#FF9800{%- else -%}#F44336{%- endif -%}
                  {%- else -%}white{%- endif -%}
                {%- endmacro -%}
                
                {%- set coul = (state_attr(s, 'couleur').valeur | lower) if state_attr(s, 'couleur') else '' -%}
                {%- if 'rouge' in coul -%} {%- set hex_coul = '#8B0000' -%}
                {%- elif 'blanc' in coul -%} {%- set hex_coul = '#F3E5AB' -%}
                {%- elif 'rosÃ©' in coul or 'rose' in coul -%} {%- set hex_coul = '#FFB6C1' -%}
                {%- else -%} {%- set hex_coul = '#707070' -%}
                {%- endif -%}

                {# Logique de l'indicateur d'apogÃ©e MÃ©lange PersonnalisÃ© #}
                {%- set annee_actuelle = now().year -%}
                {%- set apogee_brut = state_attr(s, 'apogee').valeur -%}
                {%- set apogee = apogee_brut | replace(' ','') | regex_findall_index('\d{4}', index=0) | int if apogee_brut is string and '20' in apogee_brut else apogee_brut | int(0) -%}
                
                {%- if apogee == 0 -%}
                  {%- set indic = "" -%}
                {%- elif apogee > annee_actuelle -%}
                  {%- set indic = " â³" -%} {# Sablier : Attente #}
                {%- elif apogee < annee_actuelle -%}
                  {%- set indic = " ğŸ‚" -%} {# Feuille : DÃ©clin #}
                {%- else -%}
                  {%- set indic = " ğŸ’" -%} {# Diamant : ApogÃ©e #}
                {%- endif -%}

                <font size="5" color="{{ hex_coul }}">â—</font>{{ indic }} <font size="4"><b>{{ state_attr(s, 'nom').valeur }}</b></font><br>
                <i>{{ state_attr(s, 'annee').valeur }} - {{ state_attr(s, 'appellation').valeur }}</i>
                â­ <font color="{{ get_c('note_moyenne') }}">{{ state_attr(s, 'note_moyenne').valeur }}</font> - ğŸ’° <font color="{{ get_c('prix_moyen') }}">{{ state_attr(s, 'prix_moyen').valeur }}</font><br>
                <b>Garde :</b> <font color="{{ get_c('garde_conseillee') }}">{{ state_attr(s, 'garde_conseillee').valeur }}</font>
                <b>ApogÃ©e :</b> <font color="{{ get_c('apogee') }}">{{ state_attr(s, 'apogee').valeur }}</font>
              {% else %}
                **Emplacement 2** :
                <font color="gray">*Emplacement Libre*</font>
              {% endif %}
          - type: entities
            entities:
              - entity: input_number.quantite_vin_2
                name: Nombre de bouteilles
                icon: mdi:counter
            show_header_toggle: false
            state_color: false
        grid_options:
          columns: 6
          rows: 8
      - type: vertical-stack
        visibility:
          - condition: state
            entity: sensor.vin_3
            state_not: Vide
        cards:
          - type: markdown
            content: |
              {% set s = 'sensor.vin_3' %}
              {% if states(s) != 'Vide' and states(s) != 'unknown' %}
                {%- macro get_c(attr) -%}
                  {%- set data = state_attr(s, attr) -%}
                  {%- if data is not none and data.confiance is defined -%}
                    {%- set n = data.confiance | replace('%','') | int -%}
                    {%- if n >= 95 -%}#00FF00{%- elif n >= 90 -%}#228B22{%- elif n >= 80 -%}#CDDC39{%- elif n >= 60 -%}#FF9800{%- else -%}#F44336{%- endif -%}
                  {%- else -%}white{%- endif -%}
                {%- endmacro -%}
                
                {%- set coul = (state_attr(s, 'couleur').valeur | lower) if state_attr(s, 'couleur') else '' -%}
                {%- if 'rouge' in coul -%} {%- set hex_coul = '#8B0000' -%}
                {%- elif 'blanc' in coul -%} {%- set hex_coul = '#F3E5AB' -%}
                {%- elif 'rosÃ©' in coul or 'rose' in coul -%} {%- set hex_coul = '#FFB6C1' -%}
                {%- else -%} {%- set hex_coul = '#707070' -%}
                {%- endif -%}

                {# Logique de l'indicateur d'apogÃ©e MÃ©lange PersonnalisÃ© #}
                {%- set annee_actuelle = now().year -%}
                {%- set apogee_brut = state_attr(s, 'apogee').valeur -%}
                {%- set apogee = apogee_brut | replace(' ','') | regex_findall_index('\d{4}', index=0) | int if apogee_brut is string and '20' in apogee_brut else apogee_brut | int(0) -%}
                
                {%- if apogee == 0 -%}
                  {%- set indic = "" -%}
                {%- elif apogee > annee_actuelle -%}
                  {%- set indic = " â³" -%} {# Sablier : Attente #}
                {%- elif apogee < annee_actuelle -%}
                  {%- set indic = " ğŸ‚" -%} {# Feuille : DÃ©clin #}
                {%- else -%}
                  {%- set indic = " ğŸ’" -%} {# Diamant : ApogÃ©e #}
                {%- endif -%}

                <font size="5" color="{{ hex_coul }}">â—</font>{{ indic }} <font size="4"><b>{{ state_attr(s, 'nom').valeur }}</b></font><br>
                <i>{{ state_attr(s, 'annee').valeur }} - {{ state_attr(s, 'appellation').valeur }}</i>
                â­ <font color="{{ get_c('note_moyenne') }}">{{ state_attr(s, 'note_moyenne').valeur }}</font> - ğŸ’° <font color="{{ get_c('prix_moyen') }}">{{ state_attr(s, 'prix_moyen').valeur }}</font><br>
                <b>Garde :</b> <font color="{{ get_c('garde_conseillee') }}">{{ state_attr(s, 'garde_conseillee').valeur }}</font>
                <b>ApogÃ©e :</b> <font color="{{ get_c('apogee') }}">{{ state_attr(s, 'apogee').valeur }}</font>
              {% else %}
                **Emplacement 3** :
                <font color="gray">*Emplacement Libre*</font>
              {% endif %}
          - type: entities
            entities:
              - entity: input_number.quantite_vin_3
                name: Nombre de bouteilles
                icon: mdi:counter
            show_header_toggle: false
            state_color: false
        grid_options:
          columns: 6
          rows: 8
      - type: vertical-stack
        visibility:
          - condition: state
            entity: sensor.vin_4
            state_not: Vide
        cards:
          - type: markdown
            content: |
              {% set s = 'sensor.vin_4' %}
              {% if states(s) != 'Vide' and states(s) != 'unknown' %}
                {%- macro get_c(attr) -%}
                  {%- set data = state_attr(s, attr) -%}
                  {%- if data is not none and data.confiance is defined -%}
                    {%- set n = data.confiance | replace('%','') | int -%}
                    {%- if n >= 95 -%}#00FF00{%- elif n >= 90 -%}#228B22{%- elif n >= 80 -%}#CDDC39{%- elif n >= 60 -%}#FF9800{%- else -%}#F44336{%- endif -%}
                  {%- else -%}white{%- endif -%}
                {%- endmacro -%}
                
                {%- set coul = (state_attr(s, 'couleur').valeur | lower) if state_attr(s, 'couleur') else '' -%}
                {%- if 'rouge' in coul -%} {%- set hex_coul = '#8B0000' -%}
                {%- elif 'blanc' in coul -%} {%- set hex_coul = '#F3E5AB' -%}
                {%- elif 'rosÃ©' in coul or 'rose' in coul -%} {%- set hex_coul = '#FFB6C1' -%}
                {%- else -%} {%- set hex_coul = '#707070' -%}
                {%- endif -%}

                {# Logique de l'indicateur d'apogÃ©e MÃ©lange PersonnalisÃ© #}
                {%- set annee_actuelle = now().year -%}
                {%- set apogee_brut = state_attr(s, 'apogee').valeur -%}
                {%- set apogee = apogee_brut | replace(' ','') | regex_findall_index('\d{4}', index=0) | int if apogee_brut is string and '20' in apogee_brut else apogee_brut | int(0) -%}
                
                {%- if apogee == 0 -%}
                  {%- set indic = "" -%}
                {%- elif apogee > annee_actuelle -%}
                  {%- set indic = " â³" -%} {# Sablier : Attente #}
                {%- elif apogee < annee_actuelle -%}
                  {%- set indic = " ğŸ‚" -%} {# Feuille : DÃ©clin #}
                {%- else -%}
                  {%- set indic = " ğŸ’" -%} {# Diamant : ApogÃ©e #}
                {%- endif -%}

                <font size="5" color="{{ hex_coul }}">â—</font>{{ indic }} <font size="4"><b>{{ state_attr(s, 'nom').valeur }}</b></font><br>
                <i>{{ state_attr(s, 'annee').valeur }} - {{ state_attr(s, 'appellation').valeur }}</i>
                â­ <font color="{{ get_c('note_moyenne') }}">{{ state_attr(s, 'note_moyenne').valeur }}</font> - ğŸ’° <font color="{{ get_c('prix_moyen') }}">{{ state_attr(s, 'prix_moyen').valeur }}</font><br>
                <b>Garde :</b> <font color="{{ get_c('garde_conseillee') }}">{{ state_attr(s, 'garde_conseillee').valeur }}</font>
                <b>ApogÃ©e :</b> <font color="{{ get_c('apogee') }}">{{ state_attr(s, 'apogee').valeur }}</font>
              {% else %}
                **Emplacement 4** :
                <font color="gray">*Emplacement Libre*</font>
              {% endif %}
          - type: entities
            entities:
              - entity: input_number.quantite_vin_4
                name: Nombre de bouteilles
                icon: mdi:counter
            show_header_toggle: false
            state_color: false
        grid_options:
          columns: 6
          rows: 8
      - type: vertical-stack
        visibility:
          - condition: state
            entity: sensor.vin_5
            state_not: Vide
        cards:
          - type: markdown
            content: |
              {% set s = 'sensor.vin_5' %}
              {% if states(s) != 'Vide' and states(s) != 'unknown' %}
                {%- macro get_c(attr) -%}
                  {%- set data = state_attr(s, attr) -%}
                  {%- if data is not none and data.confiance is defined -%}
                    {%- set n = data.confiance | replace('%','') | int -%}
                    {%- if n >= 95 -%}#00FF00{%- elif n >= 90 -%}#228B22{%- elif n >= 80 -%}#CDDC39{%- elif n >= 60 -%}#FF9800{%- else -%}#F44336{%- endif -%}
                  {%- else -%}white{%- endif -%}
                {%- endmacro -%}
                
                {%- set coul = (state_attr(s, 'couleur').valeur | lower) if state_attr(s, 'couleur') else '' -%}
                {%- if 'rouge' in coul -%} {%- set hex_coul = '#8B0000' -%}
                {%- elif 'blanc' in coul -%} {%- set hex_coul = '#F3E5AB' -%}
                {%- elif 'rosÃ©' in coul or 'rose' in coul -%} {%- set hex_coul = '#FFB6C1' -%}
                {%- else -%} {%- set hex_coul = '#707070' -%}
                {%- endif -%}

                {# Logique de l'indicateur d'apogÃ©e MÃ©lange PersonnalisÃ© #}
                {%- set annee_actuelle = now().year -%}
                {%- set apogee_brut = state_attr(s, 'apogee').valeur -%}
                {%- set apogee = apogee_brut | replace(' ','') | regex_findall_index('\d{4}', index=0) | int if apogee_brut is string and '20' in apogee_brut else apogee_brut | int(0) -%}
                
                {%- if apogee == 0 -%}
                  {%- set indic = "" -%}
                {%- elif apogee > annee_actuelle -%}
                  {%- set indic = " â³" -%} {# Sablier : Attente #}
                {%- elif apogee < annee_actuelle -%}
                  {%- set indic = " ğŸ‚" -%} {# Feuille : DÃ©clin #}
                {%- else -%}
                  {%- set indic = " ğŸ’" -%} {# Diamant : ApogÃ©e #}
                {%- endif -%}

                <font size="5" color="{{ hex_coul }}">â—</font>{{ indic }} <font size="4"><b>{{ state_attr(s, 'nom').valeur }}</b></font><br>
                <i>{{ state_attr(s, 'annee').valeur }} - {{ state_attr(s, 'appellation').valeur }}</i>
                â­ <font color="{{ get_c('note_moyenne') }}">{{ state_attr(s, 'note_moyenne').valeur }}</font> - ğŸ’° <font color="{{ get_c('prix_moyen') }}">{{ state_attr(s, 'prix_moyen').valeur }}</font><br>
                <b>Garde :</b> <font color="{{ get_c('garde_conseillee') }}">{{ state_attr(s, 'garde_conseillee').valeur }}</font>
                <b>ApogÃ©e :</b> <font color="{{ get_c('apogee') }}">{{ state_attr(s, 'apogee').valeur }}</font>
              {% else %}
                **Emplacement 5** :
                <font color="gray">*Emplacement Libre*</font>
              {% endif %}
          - type: entities
            entities:
              - entity: input_number.quantite_vin_5
                name: Nombre de bouteilles
                icon: mdi:counter
            show_header_toggle: false
            state_color: false
        grid_options:
          columns: 6
          rows: 8
      - type: vertical-stack
        visibility:
          - condition: state
            entity: sensor.vin_6
            state_not: Vide
        cards:
          - type: markdown
            content: |
              {% set s = 'sensor.vin_6' %}
              {% if states(s) != 'Vide' and states(s) != 'unknown' %}
                {%- macro get_c(attr) -%}
                  {%- set data = state_attr(s, attr) -%}
                  {%- if data is not none and data.confiance is defined -%}
                    {%- set n = data.confiance | replace('%','') | int -%}
                    {%- if n >= 95 -%}#00FF00{%- elif n >= 90 -%}#228B22{%- elif n >= 80 -%}#CDDC39{%- elif n >= 60 -%}#FF9800{%- else -%}#F44336{%- endif -%}
                  {%- else -%}white{%- endif -%}
                {%- endmacro -%}
                
                {%- set coul = (state_attr(s, 'couleur').valeur | lower) if state_attr(s, 'couleur') else '' -%}
                {%- if 'rouge' in coul -%} {%- set hex_coul = '#8B0000' -%}
                {%- elif 'blanc' in coul -%} {%- set hex_coul = '#F3E5AB' -%}
                {%- elif 'rosÃ©' in coul or 'rose' in coul -%} {%- set hex_coul = '#FFB6C1' -%}
                {%- else -%} {%- set hex_coul = '#707070' -%}
                {%- endif -%}

                {# Logique de l'indicateur d'apogÃ©e MÃ©lange PersonnalisÃ© #}
                {%- set annee_actuelle = now().year -%}
                {%- set apogee_brut = state_attr(s, 'apogee').valeur -%}
                {%- set apogee = apogee_brut | replace(' ','') | regex_findall_index('\d{4}', index=0) | int if apogee_brut is string and '20' in apogee_brut else apogee_brut | int(0) -%}
                
                {%- if apogee == 0 -%}
                  {%- set indic = "" -%}
                {%- elif apogee > annee_actuelle -%}
                  {%- set indic = " â³" -%} {# Sablier : Attente #}
                {%- elif apogee < annee_actuelle -%}
                  {%- set indic = " ğŸ‚" -%} {# Feuille : DÃ©clin #}
                {%- else -%}
                  {%- set indic = " ğŸ’" -%} {# Diamant : ApogÃ©e #}
                {%- endif -%}

                <font size="5" color="{{ hex_coul }}">â—</font>{{ indic }} <font size="4"><b>{{ state_attr(s, 'nom').valeur }}</b></font><br>
                <i>{{ state_attr(s, 'annee').valeur }} - {{ state_attr(s, 'appellation').valeur }}</i>
                â­ <font color="{{ get_c('note_moyenne') }}">{{ state_attr(s, 'note_moyenne').valeur }}</font> - ğŸ’° <font color="{{ get_c('prix_moyen') }}">{{ state_attr(s, 'prix_moyen').valeur }}</font><br>
                <b>Garde :</b> <font color="{{ get_c('garde_conseillee') }}">{{ state_attr(s, 'garde_conseillee').valeur }}</font>
                <b>ApogÃ©e :</b> <font color="{{ get_c('apogee') }}">{{ state_attr(s, 'apogee').valeur }}</font>
              {% else %}
                **Emplacement 6** :
                <font color="gray">*Emplacement Libre*</font>
              {% endif %}
          - type: entities
            entities:
              - entity: input_number.quantite_vin_6
                name: Nombre de bouteilles
                icon: mdi:counter
            show_header_toggle: false
            state_color: false
        grid_options:
          columns: 6
          rows: 8
      - type: vertical-stack
        visibility:
          - condition: state
            entity: sensor.vin_7
            state_not: Vide
        cards:
          - type: markdown
            content: |
              {% set s = 'sensor.vin_7' %}
              {% if states(s) != 'Vide' and states(s) != 'unknown' %}
                {%- macro get_c(attr) -%}
                  {%- set data = state_attr(s, attr) -%}
                  {%- if data is not none and data.confiance is defined -%}
                    {%- set n = data.confiance | replace('%','') | int -%}
                    {%- if n >= 95 -%}#00FF00{%- elif n >= 90 -%}#228B22{%- elif n >= 80 -%}#CDDC39{%- elif n >= 60 -%}#FF9800{%- else -%}#F44336{%- endif -%}
                  {%- else -%}white{%- endif -%}
                {%- endmacro -%}
                
                {%- set coul = (state_attr(s, 'couleur').valeur | lower) if state_attr(s, 'couleur') else '' -%}
                {%- if 'rouge' in coul -%} {%- set hex_coul = '#8B0000' -%}
                {%- elif 'blanc' in coul -%} {%- set hex_coul = '#F3E5AB' -%}
                {%- elif 'rosÃ©' in coul or 'rose' in coul -%} {%- set hex_coul = '#FFB6C1' -%}
                {%- else -%} {%- set hex_coul = '#707070' -%}
                {%- endif -%}

                {# Logique de l'indicateur d'apogÃ©e MÃ©lange PersonnalisÃ© #}
                {%- set annee_actuelle = now().year -%}
                {%- set apogee_brut = state_attr(s, 'apogee').valeur -%}
                {%- set apogee = apogee_brut | replace(' ','') | regex_findall_index('\d{4}', index=0) | int if apogee_brut is string and '20' in apogee_brut else apogee_brut | int(0) -%}
                
                {%- if apogee == 0 -%}
                  {%- set indic = "" -%}
                {%- elif apogee > annee_actuelle -%}
                  {%- set indic = " â³" -%} {# Sablier : Attente #}
                {%- elif apogee < annee_actuelle -%}
                  {%- set indic = " ğŸ‚" -%} {# Feuille : DÃ©clin #}
                {%- else -%}
                  {%- set indic = " ğŸ’" -%} {# Diamant : ApogÃ©e #}
                {%- endif -%}

                <font size="5" color="{{ hex_coul }}">â—</font>{{ indic }} <font size="4"><b>{{ state_attr(s, 'nom').valeur }}</b></font><br>
                <i>{{ state_attr(s, 'annee').valeur }} - {{ state_attr(s, 'appellation').valeur }}</i>
                â­ <font color="{{ get_c('note_moyenne') }}">{{ state_attr(s, 'note_moyenne').valeur }}</font> - ğŸ’° <font color="{{ get_c('prix_moyen') }}">{{ state_attr(s, 'prix_moyen').valeur }}</font><br>
                <b>Garde :</b> <font color="{{ get_c('garde_conseillee') }}">{{ state_attr(s, 'garde_conseillee').valeur }}</font>
                <b>ApogÃ©e :</b> <font color="{{ get_c('apogee') }}">{{ state_attr(s, 'apogee').valeur }}</font>
              {% else %}
                **Emplacement 7** :
                <font color="gray">*Emplacement Libre*</font>
              {% endif %}
          - type: entities
            entities:
              - entity: input_number.quantite_vin_7
                name: Nombre de bouteilles
                icon: mdi:counter
            show_header_toggle: false
            state_color: false
        grid_options:
          columns: 6
          rows: 8
      - type: vertical-stack
        visibility:
          - condition: state
            entity: sensor.vin_8
            state_not: Vide
        cards:
          - type: markdown
            content: |
              {% set s = 'sensor.vin_8' %}
              {% if states(s) != 'Vide' and states(s) != 'unknown' %}
                {%- macro get_c(attr) -%}
                  {%- set data = state_attr(s, attr) -%}
                  {%- if data is not none and data.confiance is defined -%}
                    {%- set n = data.confiance | replace('%','') | int -%}
                    {%- if n >= 95 -%}#00FF00{%- elif n >= 90 -%}#228B22{%- elif n >= 80 -%}#CDDC39{%- elif n >= 60 -%}#FF9800{%- else -%}#F44336{%- endif -%}
                  {%- else -%}white{%- endif -%}
                {%- endmacro -%}
                
                {%- set coul = (state_attr(s, 'couleur').valeur | lower) if state_attr(s, 'couleur') else '' -%}
                {%- if 'rouge' in coul -%} {%- set hex_coul = '#8B0000' -%}
                {%- elif 'blanc' in coul -%} {%- set hex_coul = '#F3E5AB' -%}
                {%- elif 'rosÃ©' in coul or 'rose' in coul -%} {%- set hex_coul = '#FFB6C1' -%}
                {%- else -%} {%- set hex_coul = '#707070' -%}
                {%- endif -%}

                {# Logique de l'indicateur d'apogÃ©e MÃ©lange PersonnalisÃ© #}
                {%- set annee_actuelle = now().year -%}
                {%- set apogee_brut = state_attr(s, 'apogee').valeur -%}
                {%- set apogee = apogee_brut | replace(' ','') | regex_findall_index('\d{4}', index=0) | int if apogee_brut is string and '20' in apogee_brut else apogee_brut | int(0) -%}
                
                {%- if apogee == 0 -%}
                  {%- set indic = "" -%}
                {%- elif apogee > annee_actuelle -%}
                  {%- set indic = " â³" -%} {# Sablier : Attente #}
                {%- elif apogee < annee_actuelle -%}
                  {%- set indic = " ğŸ‚" -%} {# Feuille : DÃ©clin #}
                {%- else -%}
                  {%- set indic = " ğŸ’" -%} {# Diamant : ApogÃ©e #}
                {%- endif -%}

                <font size="5" color="{{ hex_coul }}">â—</font>{{ indic }} <font size="4"><b>{{ state_attr(s, 'nom').valeur }}</b></font><br>
                <i>{{ state_attr(s, 'annee').valeur }} - {{ state_attr(s, 'appellation').valeur }}</i>
                â­ <font color="{{ get_c('note_moyenne') }}">{{ state_attr(s, 'note_moyenne').valeur }}</font> - ğŸ’° <font color="{{ get_c('prix_moyen') }}">{{ state_attr(s, 'prix_moyen').valeur }}</font><br>
                <b>Garde :</b> <font color="{{ get_c('garde_conseillee') }}">{{ state_attr(s, 'garde_conseillee').valeur }}</font>
                <b>ApogÃ©e :</b> <font color="{{ get_c('apogee') }}">{{ state_attr(s, 'apogee').valeur }}</font>
              {% else %}
                **Emplacement 8** :
                <font color="gray">*Emplacement Libre*</font>
              {% endif %}
          - type: entities
            entities:
              - entity: input_number.quantite_vin_8
                name: Nombre de bouteilles
                icon: mdi:counter
            show_header_toggle: false
            state_color: false
        grid_options:
          columns: 6
          rows: 8
      - type: vertical-stack
        visibility:
          - condition: state
            entity: sensor.vin_9
            state_not: Vide
        cards:
          - type: markdown
            content: |
              {% set s = 'sensor.vin_9' %}
              {% if states(s) != 'Vide' and states(s) != 'unknown' %}
                {%- macro get_c(attr) -%}
                  {%- set data = state_attr(s, attr) -%}
                  {%- if data is not none and data.confiance is defined -%}
                    {%- set n = data.confiance | replace('%','') | int -%}
                    {%- if n >= 95 -%}#00FF00{%- elif n >= 90 -%}#228B22{%- elif n >= 80 -%}#CDDC39{%- elif n >= 60 -%}#FF9800{%- else -%}#F44336{%- endif -%}
                  {%- else -%}white{%- endif -%}
                {%- endmacro -%}
                
                {%- set coul = (state_attr(s, 'couleur').valeur | lower) if state_attr(s, 'couleur') else '' -%}
                {%- if 'rouge' in coul -%} {%- set hex_coul = '#8B0000' -%}
                {%- elif 'blanc' in coul -%} {%- set hex_coul = '#F3E5AB' -%}
                {%- elif 'rosÃ©' in coul or 'rose' in coul -%} {%- set hex_coul = '#FFB6C1' -%}
                {%- else -%} {%- set hex_coul = '#707070' -%}
                {%- endif -%}

                {# Logique de l'indicateur d'apogÃ©e MÃ©lange PersonnalisÃ© #}
                {%- set annee_actuelle = now().year -%}
                {%- set apogee_brut = state_attr(s, 'apogee').valeur -%}
                {%- set apogee = apogee_brut | replace(' ','') | regex_findall_index('\d{4}', index=0) | int if apogee_brut is string and '20' in apogee_brut else apogee_brut | int(0) -%}
                
                {%- if apogee == 0 -%}
                  {%- set indic = "" -%}
                {%- elif apogee > annee_actuelle -%}
                  {%- set indic = " â³" -%} {# Sablier : Attente #}
                {%- elif apogee < annee_actuelle -%}
                  {%- set indic = " ğŸ‚" -%} {# Feuille : DÃ©clin #}
                {%- else -%}
                  {%- set indic = " ğŸ’" -%} {# Diamant : ApogÃ©e #}
                {%- endif -%}

                <font size="5" color="{{ hex_coul }}">â—</font>{{ indic }} <font size="4"><b>{{ state_attr(s, 'nom').valeur }}</b></font><br>
                <i>{{ state_attr(s, 'annee').valeur }} - {{ state_attr(s, 'appellation').valeur }}</i>
                â­ <font color="{{ get_c('note_moyenne') }}">{{ state_attr(s, 'note_moyenne').valeur }}</font> - ğŸ’° <font color="{{ get_c('prix_moyen') }}">{{ state_attr(s, 'prix_moyen').valeur }}</font><br>
                <b>Garde :</b> <font color="{{ get_c('garde_conseillee') }}">{{ state_attr(s, 'garde_conseillee').valeur }}</font>
                <b>ApogÃ©e :</b> <font color="{{ get_c('apogee') }}">{{ state_attr(s, 'apogee').valeur }}</font>
              {% else %}
                **Emplacement 9** :
                <font color="gray">*Emplacement Libre*</font>
              {% endif %}
          - type: entities
            entities:
              - entity: input_number.quantite_vin_9
                name: Nombre de bouteilles
                icon: mdi:counter
            show_header_toggle: false
            state_color: false
        grid_options:
          columns: 6
          rows: 8
      - type: vertical-stack
        visibility:
          - condition: state
            entity: sensor.vin_10
            state_not: Vide
        cards:
          - type: markdown
            content: |
              {% set s = 'sensor.vin_10' %}
              {% if states(s) != 'Vide' and states(s) != 'unknown' %}
                {%- macro get_c(attr) -%}
                  {%- set data = state_attr(s, attr) -%}
                  {%- if data is not none and data.confiance is defined -%}
                    {%- set n = data.confiance | replace('%','') | int -%}
                    {%- if n >= 95 -%}#00FF00{%- elif n >= 90 -%}#228B22{%- elif n >= 80 -%}#CDDC39{%- elif n >= 60 -%}#FF9800{%- else -%}#F44336{%- endif -%}
                  {%- else -%}white{%- endif -%}
                {%- endmacro -%}
                
                {%- set coul = (state_attr(s, 'couleur').valeur | lower) if state_attr(s, 'couleur') else '' -%}
                {%- if 'rouge' in coul -%} {%- set hex_coul = '#8B0000' -%}
                {%- elif 'blanc' in coul -%} {%- set hex_coul = '#F3E5AB' -%}
                {%- elif 'rosÃ©' in coul or 'rose' in coul -%} {%- set hex_coul = '#FFB6C1' -%}
                {%- else -%} {%- set hex_coul = '#707070' -%}
                {%- endif -%}

                {# Logique de l'indicateur d'apogÃ©e MÃ©lange PersonnalisÃ© #}
                {%- set annee_actuelle = now().year -%}
                {%- set apogee_brut = state_attr(s, 'apogee').valeur -%}
                {%- set apogee = apogee_brut | replace(' ','') | regex_findall_index('\d{4}', index=0) | int if apogee_brut is string and '20' in apogee_brut else apogee_brut | int(0) -%}
                
                {%- if apogee == 0 -%}
                  {%- set indic = "" -%}
                {%- elif apogee > annee_actuelle -%}
                  {%- set indic = " â³" -%} {# Sablier : Attente #}
                {%- elif apogee < annee_actuelle -%}
                  {%- set indic = " ğŸ‚" -%} {# Feuille : DÃ©clin #}
                {%- else -%}
                  {%- set indic = " ğŸ’" -%} {# Diamant : ApogÃ©e #}
                {%- endif -%}

                <font size="5" color="{{ hex_coul }}">â—</font>{{ indic }} <font size="4"><b>{{ state_attr(s, 'nom').valeur }}</b></font><br>
                <i>{{ state_attr(s, 'annee').valeur }} - {{ state_attr(s, 'appellation').valeur }}</i>
                â­ <font color="{{ get_c('note_moyenne') }}">{{ state_attr(s, 'note_moyenne').valeur }}</font> - ğŸ’° <font color="{{ get_c('prix_moyen') }}">{{ state_attr(s, 'prix_moyen').valeur }}</font><br>
                <b>Garde :</b> <font color="{{ get_c('garde_conseillee') }}">{{ state_attr(s, 'garde_conseillee').valeur }}</font>
                <b>ApogÃ©e :</b> <font color="{{ get_c('apogee') }}">{{ state_attr(s, 'apogee').valeur }}</font>
              {% else %}
                **Emplacement 10** :
                <font color="gray">*Emplacement Libre*</font>
              {% endif %}
          - type: entities
            entities:
              - entity: input_number.quantite_vin_10
                name: Nombre de bouteilles
                icon: mdi:counter
            show_header_toggle: false
            state_color: false
        grid_options:
          columns: 6
          rows: 8
      - type: vertical-stack
        visibility:
          - condition: state
            entity: sensor.vin_11
            state_not: Vide
        cards:
          - type: markdown
            content: |
              {% set s = 'sensor.vin_11' %}
              {% if states(s) != 'Vide' and states(s) != 'unknown' %}
                {%- macro get_c(attr) -%}
                  {%- set data = state_attr(s, attr) -%}
                  {%- if data is not none and data.confiance is defined -%}
                    {%- set n = data.confiance | replace('%','') | int -%}
                    {%- if n >= 95 -%}#00FF00{%- elif n >= 90 -%}#228B22{%- elif n >= 80 -%}#CDDC39{%- elif n >= 60 -%}#FF9800{%- else -%}#F44336{%- endif -%}
                  {%- else -%}white{%- endif -%}
                {%- endmacro -%}
                
                {%- set coul = (state_attr(s, 'couleur').valeur | lower) if state_attr(s, 'couleur') else '' -%}
                {%- if 'rouge' in coul -%} {%- set hex_coul = '#8B0000' -%}
                {%- elif 'blanc' in coul -%} {%- set hex_coul = '#F3E5AB' -%}
                {%- elif 'rosÃ©' in coul or 'rose' in coul -%} {%- set hex_coul = '#FFB6C1' -%}
                {%- else -%} {%- set hex_coul = '#707070' -%}
                {%- endif -%}

                {# Logique de l'indicateur d'apogÃ©e MÃ©lange PersonnalisÃ© #}
                {%- set annee_actuelle = now().year -%}
                {%- set apogee_brut = state_attr(s, 'apogee').valeur -%}
                {%- set apogee = apogee_brut | replace(' ','') | regex_findall_index('\d{4}', index=0) | int if apogee_brut is string and '20' in apogee_brut else apogee_brut | int(0) -%}
                
                {%- if apogee == 0 -%}
                  {%- set indic = "" -%}
                {%- elif apogee > annee_actuelle -%}
                  {%- set indic = " â³" -%} {# Sablier : Attente #}
                {%- elif apogee < annee_actuelle -%}
                  {%- set indic = " ğŸ‚" -%} {# Feuille : DÃ©clin #}
                {%- else -%}
                  {%- set indic = " ğŸ’" -%} {# Diamant : ApogÃ©e #}
                {%- endif -%}

                <font size="5" color="{{ hex_coul }}">â—</font>{{ indic }} <font size="4"><b>{{ state_attr(s, 'nom').valeur }}</b></font><br>
                <i>{{ state_attr(s, 'annee').valeur }} - {{ state_attr(s, 'appellation').valeur }}</i>
                â­ <font color="{{ get_c('note_moyenne') }}">{{ state_attr(s, 'note_moyenne').valeur }}</font> - ğŸ’° <font color="{{ get_c('prix_moyen') }}">{{ state_attr(s, 'prix_moyen').valeur }}</font><br>
                <b>Garde :</b> <font color="{{ get_c('garde_conseillee') }}">{{ state_attr(s, 'garde_conseillee').valeur }}</font>
                <b>ApogÃ©e :</b> <font color="{{ get_c('apogee') }}">{{ state_attr(s, 'apogee').valeur }}</font>
              {% else %}
                **Emplacement 11** :
                <font color="gray">*Emplacement Libre*</font>
              {% endif %}
          - type: entities
            entities:
              - entity: input_number.quantite_vin_11
                name: Nombre de bouteilles
                icon: mdi:counter
            show_header_toggle: false
            state_color: false
        grid_options:
          columns: 6
          rows: 8
      - type: vertical-stack
        visibility:
          - condition: state
            entity: sensor.vin_12
            state_not: Vide
        cards:
          - type: markdown
            content: |
              {% set s = 'sensor.vin_12' %}
              {% if states(s) != 'Vide' and states(s) != 'unknown' %}
                {%- macro get_c(attr) -%}
                  {%- set data = state_attr(s, attr) -%}
                  {%- if data is not none and data.confiance is defined -%}
                    {%- set n = data.confiance | replace('%','') | int -%}
                    {%- if n >= 95 -%}#00FF00{%- elif n >= 90 -%}#228B22{%- elif n >= 80 -%}#CDDC39{%- elif n >= 60 -%}#FF9800{%- else -%}#F44336{%- endif -%}
                  {%- else -%}white{%- endif -%}
                {%- endmacro -%}
                
                {%- set coul = (state_attr(s, 'couleur').valeur | lower) if state_attr(s, 'couleur') else '' -%}
                {%- if 'rouge' in coul -%} {%- set hex_coul = '#8B0000' -%}
                {%- elif 'blanc' in coul -%} {%- set hex_coul = '#F3E5AB' -%}
                {%- elif 'rosÃ©' in coul or 'rose' in coul -%} {%- set hex_coul = '#FFB6C1' -%}
                {%- else -%} {%- set hex_coul = '#707070' -%}
                {%- endif -%}

                {# Logique de l'indicateur d'apogÃ©e MÃ©lange PersonnalisÃ© #}
                {%- set annee_actuelle = now().year -%}
                {%- set apogee_brut = state_attr(s, 'apogee').valeur -%}
                {%- set apogee = apogee_brut | replace(' ','') | regex_findall_index('\d{4}', index=0) | int if apogee_brut is string and '20' in apogee_brut else apogee_brut | int(0) -%}
                
                {%- if apogee == 0 -%}
                  {%- set indic = "" -%}
                {%- elif apogee > annee_actuelle -%}
                  {%- set indic = " â³" -%} {# Sablier : Attente #}
                {%- elif apogee < annee_actuelle -%}
                  {%- set indic = " ğŸ‚" -%} {# Feuille : DÃ©clin #}
                {%- else -%}
                  {%- set indic = " ğŸ’" -%} {# Diamant : ApogÃ©e #}
                {%- endif -%}

                <font size="5" color="{{ hex_coul }}">â—</font>{{ indic }} <font size="4"><b>{{ state_attr(s, 'nom').valeur }}</b></font><br>
                <i>{{ state_attr(s, 'annee').valeur }} - {{ state_attr(s, 'appellation').valeur }}</i>
                â­ <font color="{{ get_c('note_moyenne') }}">{{ state_attr(s, 'note_moyenne').valeur }}</font> - ğŸ’° <font color="{{ get_c('prix_moyen') }}">{{ state_attr(s, 'prix_moyen').valeur }}</font><br>
                <b>Garde :</b> <font color="{{ get_c('garde_conseillee') }}">{{ state_attr(s, 'garde_conseillee').valeur }}</font>
                <b>ApogÃ©e :</b> <font color="{{ get_c('apogee') }}">{{ state_attr(s, 'apogee').valeur }}</font>
              {% else %}
                **Emplacement 12** :
                <font color="gray">*Emplacement Libre*</font>
              {% endif %}
          - type: entities
            entities:
              - entity: input_number.quantite_vin_12
                name: Nombre de bouteilles
                icon: mdi:counter
            show_header_toggle: false
            state_color: false
        grid_options:
          columns: 6
          rows: 8
      - type: vertical-stack
        visibility:
          - condition: state
            entity: sensor.vin_13
            state_not: Vide
        cards:
          - type: markdown
            content: |
              {% set s = 'sensor.vin_13' %}
              {% if states(s) != 'Vide' and states(s) != 'unknown' %}
                {%- macro get_c(attr) -%}
                  {%- set data = state_attr(s, attr) -%}
                  {%- if data is not none and data.confiance is defined -%}
                    {%- set n = data.confiance | replace('%','') | int -%}
                    {%- if n >= 95 -%}#00FF00{%- elif n >= 90 -%}#228B22{%- elif n >= 80 -%}#CDDC39{%- elif n >= 60 -%}#FF9800{%- else -%}#F44336{%- endif -%}
                  {%- else -%}white{%- endif -%}
                {%- endmacro -%}
                
                {%- set coul = (state_attr(s, 'couleur').valeur | lower) if state_attr(s, 'couleur') else '' -%}
                {%- if 'rouge' in coul -%} {%- set hex_coul = '#8B0000' -%}
                {%- elif 'blanc' in coul -%} {%- set hex_coul = '#F3E5AB' -%}
                {%- elif 'rosÃ©' in coul or 'rose' in coul -%} {%- set hex_coul = '#FFB6C1' -%}
                {%- else -%} {%- set hex_coul = '#707070' -%}
                {%- endif -%}

                {# Logique de l'indicateur d'apogÃ©e MÃ©lange PersonnalisÃ© #}
                {%- set annee_actuelle = now().year -%}
                {%- set apogee_brut = state_attr(s, 'apogee').valeur -%}
                {%- set apogee = apogee_brut | replace(' ','') | regex_findall_index('\d{4}', index=0) | int if apogee_brut is string and '20' in apogee_brut else apogee_brut | int(0) -%}
                
                {%- if apogee == 0 -%}
                  {%- set indic = "" -%}
                {%- elif apogee > annee_actuelle -%}
                  {%- set indic = " â³" -%} {# Sablier : Attente #}
                {%- elif apogee < annee_actuelle -%}
                  {%- set indic = " ğŸ‚" -%} {# Feuille : DÃ©clin #}
                {%- else -%}
                  {%- set indic = " ğŸ’" -%} {# Diamant : ApogÃ©e #}
                {%- endif -%}

                <font size="5" color="{{ hex_coul }}">â—</font>{{ indic }} <font size="4"><b>{{ state_attr(s, 'nom').valeur }}</b></font><br>
                <i>{{ state_attr(s, 'annee').valeur }} - {{ state_attr(s, 'appellation').valeur }}</i>
                â­ <font color="{{ get_c('note_moyenne') }}">{{ state_attr(s, 'note_moyenne').valeur }}</font> - ğŸ’° <font color="{{ get_c('prix_moyen') }}">{{ state_attr(s, 'prix_moyen').valeur }}</font><br>
                <b>Garde :</b> <font color="{{ get_c('garde_conseillee') }}">{{ state_attr(s, 'garde_conseillee').valeur }}</font>
                <b>ApogÃ©e :</b> <font color="{{ get_c('apogee') }}">{{ state_attr(s, 'apogee').valeur }}</font>
              {% else %}
                **Emplacement 13** :
                <font color="gray">*Emplacement Libre*</font>
              {% endif %}
          - type: entities
            entities:
              - entity: input_number.quantite_vin_13
                name: Nombre de bouteilles
                icon: mdi:counter
            show_header_toggle: false
            state_color: false
        grid_options:
          columns: 6
          rows: 8
      - type: vertical-stack
        visibility:
          - condition: state
            entity: sensor.vin_14
            state_not: Vide
        cards:
          - type: markdown
            content: |
              {% set s = 'sensor.vin_14' %}
              {% if states(s) != 'Vide' and states(s) != 'unknown' %}
                {%- macro get_c(attr) -%}
                  {%- set data = state_attr(s, attr) -%}
                  {%- if data is not none and data.confiance is defined -%}
                    {%- set n = data.confiance | replace('%','') | int -%}
                    {%- if n >= 95 -%}#00FF00{%- elif n >= 90 -%}#228B22{%- elif n >= 80 -%}#CDDC39{%- elif n >= 60 -%}#FF9800{%- else -%}#F44336{%- endif -%}
                  {%- else -%}white{%- endif -%}
                {%- endmacro -%}
                
                {%- set coul = (state_attr(s, 'couleur').valeur | lower) if state_attr(s, 'couleur') else '' -%}
                {%- if 'rouge' in coul -%} {%- set hex_coul = '#8B0000' -%}
                {%- elif 'blanc' in coul -%} {%- set hex_coul = '#F3E5AB' -%}
                {%- elif 'rosÃ©' in coul or 'rose' in coul -%} {%- set hex_coul = '#FFB6C1' -%}
                {%- else -%} {%- set hex_coul = '#707070' -%}
                {%- endif -%}

                {# Logique de l'indicateur d'apogÃ©e MÃ©lange PersonnalisÃ© #}
                {%- set annee_actuelle = now().year -%}
                {%- set apogee_brut = state_attr(s, 'apogee').valeur -%}
                {%- set apogee = apogee_brut | replace(' ','') | regex_findall_index('\d{4}', index=0) | int if apogee_brut is string and '20' in apogee_brut else apogee_brut | int(0) -%}
                
                {%- if apogee == 0 -%}
                  {%- set indic = "" -%}
                {%- elif apogee > annee_actuelle -%}
                  {%- set indic = " â³" -%} {# Sablier : Attente #}
                {%- elif apogee < annee_actuelle -%}
                  {%- set indic = " ğŸ‚" -%} {# Feuille : DÃ©clin #}
                {%- else -%}
                  {%- set indic = " ğŸ’" -%} {# Diamant : ApogÃ©e #}
                {%- endif -%}

                <font size="5" color="{{ hex_coul }}">â—</font>{{ indic }} <font size="4"><b>{{ state_attr(s, 'nom').valeur }}</b></font><br>
                <i>{{ state_attr(s, 'annee').valeur }} - {{ state_attr(s, 'appellation').valeur }}</i>
                â­ <font color="{{ get_c('note_moyenne') }}">{{ state_attr(s, 'note_moyenne').valeur }}</font> - ğŸ’° <font color="{{ get_c('prix_moyen') }}">{{ state_attr(s, 'prix_moyen').valeur }}</font><br>
                <b>Garde :</b> <font color="{{ get_c('garde_conseillee') }}">{{ state_attr(s, 'garde_conseillee').valeur }}</font>
                <b>ApogÃ©e :</b> <font color="{{ get_c('apogee') }}">{{ state_attr(s, 'apogee').valeur }}</font>
              {% else %}
                **Emplacement 14** :
                <font color="gray">*Emplacement Libre*</font>
              {% endif %}
          - type: entities
            entities:
              - entity: input_number.quantite_vin_14
                name: Nombre de bouteilles
                icon: mdi:counter
            show_header_toggle: false
            state_color: false
        grid_options:
          columns: 6
          rows: 8
      - type: vertical-stack
        visibility:
          - condition: state
            entity: sensor.vin_15
            state_not: Vide
        cards:
          - type: markdown
            content: |
              {% set s = 'sensor.vin_15' %}
              {% if states(s) != 'Vide' and states(s) != 'unknown' %}
                {%- macro get_c(attr) -%}
                  {%- set data = state_attr(s, attr) -%}
                  {%- if data is not none and data.confiance is defined -%}
                    {%- set n = data.confiance | replace('%','') | int -%}
                    {%- if n >= 95 -%}#00FF00{%- elif n >= 90 -%}#228B22{%- elif n >= 80 -%}#CDDC39{%- elif n >= 60 -%}#FF9800{%- else -%}#F44336{%- endif -%}
                  {%- else -%}white{%- endif -%}
                {%- endmacro -%}
                
                {%- set coul = (state_attr(s, 'couleur').valeur | lower) if state_attr(s, 'couleur') else '' -%}
                {%- if 'rouge' in coul -%} {%- set hex_coul = '#8B0000' -%}
                {%- elif 'blanc' in coul -%} {%- set hex_coul = '#F3E5AB' -%}
                {%- elif 'rosÃ©' in coul or 'rose' in coul -%} {%- set hex_coul = '#FFB6C1' -%}
                {%- else -%} {%- set hex_coul = '#707070' -%}
                {%- endif -%}

                {# Logique de l'indicateur d'apogÃ©e MÃ©lange PersonnalisÃ© #}
                {%- set annee_actuelle = now().year -%}
                {%- set apogee_brut = state_attr(s, 'apogee').valeur -%}
                {%- set apogee = apogee_brut | replace(' ','') | regex_findall_index('\d{4}', index=0) | int if apogee_brut is string and '20' in apogee_brut else apogee_brut | int(0) -%}
                
                {%- if apogee == 0 -%}
                  {%- set indic = "" -%}
                {%- elif apogee > annee_actuelle -%}
                  {%- set indic = " â³" -%} {# Sablier : Attente #}
                {%- elif apogee < annee_actuelle -%}
                  {%- set indic = " ğŸ‚" -%} {# Feuille : DÃ©clin #}
                {%- else -%}
                  {%- set indic = " ğŸ’" -%} {# Diamant : ApogÃ©e #}
                {%- endif -%}

                <font size="5" color="{{ hex_coul }}">â—</font>{{ indic }} <font size="4"><b>{{ state_attr(s, 'nom').valeur }}</b></font><br>
                <i>{{ state_attr(s, 'annee').valeur }} - {{ state_attr(s, 'appellation').valeur }}</i>
                â­ <font color="{{ get_c('note_moyenne') }}">{{ state_attr(s, 'note_moyenne').valeur }}</font> - ğŸ’° <font color="{{ get_c('prix_moyen') }}">{{ state_attr(s, 'prix_moyen').valeur }}</font><br>
                <b>Garde :</b> <font color="{{ get_c('garde_conseillee') }}">{{ state_attr(s, 'garde_conseillee').valeur }}</font>
                <b>ApogÃ©e :</b> <font color="{{ get_c('apogee') }}">{{ state_attr(s, 'apogee').valeur }}</font>
              {% else %}
                **Emplacement 15** :
                <font color="gray">*Emplacement Libre*</font>
              {% endif %}
          - type: entities
            entities:
              - entity: input_number.quantite_vin_15
                name: Nombre de bouteilles
                icon: mdi:counter
            show_header_toggle: false
            state_color: false
        grid_options:
          columns: 6
          rows: 8
      - type: vertical-stack
        visibility:
          - condition: state
            entity: sensor.vin_16
            state_not: Vide
        cards:
          - type: markdown
            content: |
              {% set s = 'sensor.vin_16' %}
              {% if states(s) != 'Vide' and states(s) != 'unknown' %}
                {%- macro get_c(attr) -%}
                  {%- set data = state_attr(s, attr) -%}
                  {%- if data is not none and data.confiance is defined -%}
                    {%- set n = data.confiance | replace('%','') | int -%}
                    {%- if n >= 95 -%}#00FF00{%- elif n >= 90 -%}#228B22{%- elif n >= 80 -%}#CDDC39{%- elif n >= 60 -%}#FF9800{%- else -%}#F44336{%- endif -%}
                  {%- else -%}white{%- endif -%}
                {%- endmacro -%}
                
                {%- set coul = (state_attr(s, 'couleur').valeur | lower) if state_attr(s, 'couleur') else '' -%}
                {%- if 'rouge' in coul -%} {%- set hex_coul = '#8B0000' -%}
                {%- elif 'blanc' in coul -%} {%- set hex_coul = '#F3E5AB' -%}
                {%- elif 'rosÃ©' in coul or 'rose' in coul -%} {%- set hex_coul = '#FFB6C1' -%}
                {%- else -%} {%- set hex_coul = '#707070' -%}
                {%- endif -%}

                {# Logique de l'indicateur d'apogÃ©e MÃ©lange PersonnalisÃ© #}
                {%- set annee_actuelle = now().year -%}
                {%- set apogee_brut = state_attr(s, 'apogee').valeur -%}
                {%- set apogee = apogee_brut | replace(' ','') | regex_findall_index('\d{4}', index=0) | int if apogee_brut is string and '20' in apogee_brut else apogee_brut | int(0) -%}
                
                {%- if apogee == 0 -%}
                  {%- set indic = "" -%}
                {%- elif apogee > annee_actuelle -%}
                  {%- set indic = " â³" -%} {# Sablier : Attente #}
                {%- elif apogee < annee_actuelle -%}
                  {%- set indic = " ğŸ‚" -%} {# Feuille : DÃ©clin #}
                {%- else -%}
                  {%- set indic = " ğŸ’" -%} {# Diamant : ApogÃ©e #}
                {%- endif -%}

                <font size="5" color="{{ hex_coul }}">â—</font>{{ indic }} <font size="4"><b>{{ state_attr(s, 'nom').valeur }}</b></font><br>
                <i>{{ state_attr(s, 'annee').valeur }} - {{ state_attr(s, 'appellation').valeur }}</i>
                â­ <font color="{{ get_c('note_moyenne') }}">{{ state_attr(s, 'note_moyenne').valeur }}</font> - ğŸ’° <font color="{{ get_c('prix_moyen') }}">{{ state_attr(s, 'prix_moyen').valeur }}</font><br>
                <b>Garde :</b> <font color="{{ get_c('garde_conseillee') }}">{{ state_attr(s, 'garde_conseillee').valeur }}</font>
                <b>ApogÃ©e :</b> <font color="{{ get_c('apogee') }}">{{ state_attr(s, 'apogee').valeur }}</font>
              {% else %}
                **Emplacement 16** :
                <font color="gray">*Emplacement Libre*</font>
              {% endif %}
          - type: entities
            entities:
              - entity: input_number.quantite_vin_16
                name: Nombre de bouteilles
                icon: mdi:counter
            show_header_toggle: false
            state_color: false
        grid_options:
          columns: 6
          rows: 8
      - type: vertical-stack
        visibility:
          - condition: state
            entity: sensor.vin_17
            state_not: Vide
        cards:
          - type: markdown
            content: |
              {% set s = 'sensor.vin_17' %}
              {% if states(s) != 'Vide' and states(s) != 'unknown' %}
                {%- macro get_c(attr) -%}
                  {%- set data = state_attr(s, attr) -%}
                  {%- if data is not none and data.confiance is defined -%}
                    {%- set n = data.confiance | replace('%','') | int -%}
                    {%- if n >= 95 -%}#00FF00{%- elif n >= 90 -%}#228B22{%- elif n >= 80 -%}#CDDC39{%- elif n >= 60 -%}#FF9800{%- else -%}#F44336{%- endif -%}
                  {%- else -%}white{%- endif -%}
                {%- endmacro -%}
                
                {%- set coul = (state_attr(s, 'couleur').valeur | lower) if state_attr(s, 'couleur') else '' -%}
                {%- if 'rouge' in coul -%} {%- set hex_coul = '#8B0000' -%}
                {%- elif 'blanc' in coul -%} {%- set hex_coul = '#F3E5AB' -%}
                {%- elif 'rosÃ©' in coul or 'rose' in coul -%} {%- set hex_coul = '#FFB6C1' -%}
                {%- else -%} {%- set hex_coul = '#707070' -%}
                {%- endif -%}

                {# Logique de l'indicateur d'apogÃ©e MÃ©lange PersonnalisÃ© #}
                {%- set annee_actuelle = now().year -%}
                {%- set apogee_brut = state_attr(s, 'apogee').valeur -%}
                {%- set apogee = apogee_brut | replace(' ','') | regex_findall_index('\d{4}', index=0) | int if apogee_brut is string and '20' in apogee_brut else apogee_brut | int(0) -%}
                
                {%- if apogee == 0 -%}
                  {%- set indic = "" -%}
                {%- elif apogee > annee_actuelle -%}
                  {%- set indic = " â³" -%} {# Sablier : Attente #}
                {%- elif apogee < annee_actuelle -%}
                  {%- set indic = " ğŸ‚" -%} {# Feuille : DÃ©clin #}
                {%- else -%}
                  {%- set indic = " ğŸ’" -%} {# Diamant : ApogÃ©e #}
                {%- endif -%}

                <font size="5" color="{{ hex_coul }}">â—</font>{{ indic }} <font size="4"><b>{{ state_attr(s, 'nom').valeur }}</b></font><br>
                <i>{{ state_attr(s, 'annee').valeur }} - {{ state_attr(s, 'appellation').valeur }}</i>
                â­ <font color="{{ get_c('note_moyenne') }}">{{ state_attr(s, 'note_moyenne').valeur }}</font> - ğŸ’° <font color="{{ get_c('prix_moyen') }}">{{ state_attr(s, 'prix_moyen').valeur }}</font><br>
                <b>Garde :</b> <font color="{{ get_c('garde_conseillee') }}">{{ state_attr(s, 'garde_conseillee').valeur }}</font>
                <b>ApogÃ©e :</b> <font color="{{ get_c('apogee') }}">{{ state_attr(s, 'apogee').valeur }}</font>
              {% else %}
                **Emplacement 17** :
                <font color="gray">*Emplacement Libre*</font>
              {% endif %}
          - type: entities
            entities:
              - entity: input_number.quantite_vin_17
                name: Nombre de bouteilles
                icon: mdi:counter
            show_header_toggle: false
            state_color: false
        grid_options:
          columns: 6
          rows: 8
      - type: vertical-stack
        visibility:
          - condition: state
            entity: sensor.vin_18
            state_not: Vide
        cards:
          - type: markdown
            content: |
              {% set s = 'sensor.vin_18' %}
              {% if states(s) != 'Vide' and states(s) != 'unknown' %}
                {%- macro get_c(attr) -%}
                  {%- set data = state_attr(s, attr) -%}
                  {%- if data is not none and data.confiance is defined -%}
                    {%- set n = data.confiance | replace('%','') | int -%}
                    {%- if n >= 95 -%}#00FF00{%- elif n >= 90 -%}#228B22{%- elif n >= 80 -%}#CDDC39{%- elif n >= 60 -%}#FF9800{%- else -%}#F44336{%- endif -%}
                  {%- else -%}white{%- endif -%}
                {%- endmacro -%}
                
                {%- set coul = (state_attr(s, 'couleur').valeur | lower) if state_attr(s, 'couleur') else '' -%}
                {%- if 'rouge' in coul -%} {%- set hex_coul = '#8B0000' -%}
                {%- elif 'blanc' in coul -%} {%- set hex_coul = '#F3E5AB' -%}
                {%- elif 'rosÃ©' in coul or 'rose' in coul -%} {%- set hex_coul = '#FFB6C1' -%}
                {%- else -%} {%- set hex_coul = '#707070' -%}
                {%- endif -%}

                {# Logique de l'indicateur d'apogÃ©e MÃ©lange PersonnalisÃ© #}
                {%- set annee_actuelle = now().year -%}
                {%- set apogee_brut = state_attr(s, 'apogee').valeur -%}
                {%- set apogee = apogee_brut | replace(' ','') | regex_findall_index('\d{4}', index=0) | int if apogee_brut is string and '20' in apogee_brut else apogee_brut | int(0) -%}
                
                {%- if apogee == 0 -%}
                  {%- set indic = "" -%}
                {%- elif apogee > annee_actuelle -%}
                  {%- set indic = " â³" -%} {# Sablier : Attente #}
                {%- elif apogee < annee_actuelle -%}
                  {%- set indic = " ğŸ‚" -%} {# Feuille : DÃ©clin #}
                {%- else -%}
                  {%- set indic = " ğŸ’" -%} {# Diamant : ApogÃ©e #}
                {%- endif -%}

                <font size="5" color="{{ hex_coul }}">â—</font>{{ indic }} <font size="4"><b>{{ state_attr(s, 'nom').valeur }}</b></font><br>
                <i>{{ state_attr(s, 'annee').valeur }} - {{ state_attr(s, 'appellation').valeur }}</i>
                â­ <font color="{{ get_c('note_moyenne') }}">{{ state_attr(s, 'note_moyenne').valeur }}</font> - ğŸ’° <font color="{{ get_c('prix_moyen') }}">{{ state_attr(s, 'prix_moyen').valeur }}</font><br>
                <b>Garde :</b> <font color="{{ get_c('garde_conseillee') }}">{{ state_attr(s, 'garde_conseillee').valeur }}</font>
                <b>ApogÃ©e :</b> <font color="{{ get_c('apogee') }}">{{ state_attr(s, 'apogee').valeur }}</font>
              {% else %}
                **Emplacement 18** :
                <font color="gray">*Emplacement Libre*</font>
              {% endif %}
          - type: entities
            entities:
              - entity: input_number.quantite_vin_18
                name: Nombre de bouteilles
                icon: mdi:counter
            show_header_toggle: false
            state_color: false
        grid_options:
          columns: 6
          rows: 8
      - type: vertical-stack
        visibility:
          - condition: state
            entity: sensor.vin_19
            state_not: Vide
        cards:
          - type: markdown
            content: |
              {% set s = 'sensor.vin_19' %}
              {% if states(s) != 'Vide' and states(s) != 'unknown' %}
                {%- macro get_c(attr) -%}
                  {%- set data = state_attr(s, attr) -%}
                  {%- if data is not none and data.confiance is defined -%}
                    {%- set n = data.confiance | replace('%','') | int -%}
                    {%- if n >= 95 -%}#00FF00{%- elif n >= 90 -%}#228B22{%- elif n >= 80 -%}#CDDC39{%- elif n >= 60 -%}#FF9800{%- else -%}#F44336{%- endif -%}
                  {%- else -%}white{%- endif -%}
                {%- endmacro -%}
                
                {%- set coul = (state_attr(s, 'couleur').valeur | lower) if state_attr(s, 'couleur') else '' -%}
                {%- if 'rouge' in coul -%} {%- set hex_coul = '#8B0000' -%}
                {%- elif 'blanc' in coul -%} {%- set hex_coul = '#F3E5AB' -%}
                {%- elif 'rosÃ©' in coul or 'rose' in coul -%} {%- set hex_coul = '#FFB6C1' -%}
                {%- else -%} {%- set hex_coul = '#707070' -%}
                {%- endif -%}

                {# Logique de l'indicateur d'apogÃ©e MÃ©lange PersonnalisÃ© #}
                {%- set annee_actuelle = now().year -%}
                {%- set apogee_brut = state_attr(s, 'apogee').valeur -%}
                {%- set apogee = apogee_brut | replace(' ','') | regex_findall_index('\d{4}', index=0) | int if apogee_brut is string and '20' in apogee_brut else apogee_brut | int(0) -%}
                
                {%- if apogee == 0 -%}
                  {%- set indic = "" -%}
                {%- elif apogee > annee_actuelle -%}
                  {%- set indic = " â³" -%} {# Sablier : Attente #}
                {%- elif apogee < annee_actuelle -%}
                  {%- set indic = " ğŸ‚" -%} {# Feuille : DÃ©clin #}
                {%- else -%}
                  {%- set indic = " ğŸ’" -%} {# Diamant : ApogÃ©e #}
                {%- endif -%}

                <font size="5" color="{{ hex_coul }}">â—</font>{{ indic }} <font size="4"><b>{{ state_attr(s, 'nom').valeur }}</b></font><br>
                <i>{{ state_attr(s, 'annee').valeur }} - {{ state_attr(s, 'appellation').valeur }}</i>
                â­ <font color="{{ get_c('note_moyenne') }}">{{ state_attr(s, 'note_moyenne').valeur }}</font> - ğŸ’° <font color="{{ get_c('prix_moyen') }}">{{ state_attr(s, 'prix_moyen').valeur }}</font><br>
                <b>Garde :</b> <font color="{{ get_c('garde_conseillee') }}">{{ state_attr(s, 'garde_conseillee').valeur }}</font>
                <b>ApogÃ©e :</b> <font color="{{ get_c('apogee') }}">{{ state_attr(s, 'apogee').valeur }}</font>
              {% else %}
                **Emplacement 19** :
                <font color="gray">*Emplacement Libre*</font>
              {% endif %}
          - type: entities
            entities:
              - entity: input_number.quantite_vin_19
                name: Nombre de bouteilles
                icon: mdi:counter
            show_header_toggle: false
            state_color: false
        grid_options:
          columns: 6
          rows: 8
      - type: vertical-stack
        visibility:
          - condition: state
            entity: sensor.vin_20
            state_not: Vide
        cards:
          - type: markdown
            content: |
              {% set s = 'sensor.vin_20' %}
              {% if states(s) != 'Vide' and states(s) != 'unknown' %}
                {%- macro get_c(attr) -%}
                  {%- set data = state_attr(s, attr) -%}
                  {%- if data is not none and data.confiance is defined -%}
                    {%- set n = data.confiance | replace('%','') | int -%}
                    {%- if n >= 95 -%}#00FF00{%- elif n >= 90 -%}#228B22{%- elif n >= 80 -%}#CDDC39{%- elif n >= 60 -%}#FF9800{%- else -%}#F44336{%- endif -%}
                  {%- else -%}white{%- endif -%}
                {%- endmacro -%}
                
                {%- set coul = (state_attr(s, 'couleur').valeur | lower) if state_attr(s, 'couleur') else '' -%}
                {%- if 'rouge' in coul -%} {%- set hex_coul = '#8B0000' -%}
                {%- elif 'blanc' in coul -%} {%- set hex_coul = '#F3E5AB' -%}
                {%- elif 'rosÃ©' in coul or 'rose' in coul -%} {%- set hex_coul = '#FFB6C1' -%}
                {%- else -%} {%- set hex_coul = '#707070' -%}
                {%- endif -%}

                {# Logique de l'indicateur d'apogÃ©e MÃ©lange PersonnalisÃ© #}
                {%- set annee_actuelle = now().year -%}
                {%- set apogee_brut = state_attr(s, 'apogee').valeur -%}
                {%- set apogee = apogee_brut | replace(' ','') | regex_findall_index('\d{4}', index=0) | int if apogee_brut is string and '20' in apogee_brut else apogee_brut | int(0) -%}
                
                {%- if apogee == 0 -%}
                  {%- set indic = "" -%}
                {%- elif apogee > annee_actuelle -%}
                  {%- set indic = " â³" -%} {# Sablier : Attente #}
                {%- elif apogee < annee_actuelle -%}
                  {%- set indic = " ğŸ‚" -%} {# Feuille : DÃ©clin #}
                {%- else -%}
                  {%- set indic = " ğŸ’" -%} {# Diamant : ApogÃ©e #}
                {%- endif -%}

                <font size="5" color="{{ hex_coul }}">â—</font>{{ indic }} <font size="4"><b>{{ state_attr(s, 'nom').valeur }}</b></font><br>
                <i>{{ state_attr(s, 'annee').valeur }} - {{ state_attr(s, 'appellation').valeur }}</i>
                â­ <font color="{{ get_c('note_moyenne') }}">{{ state_attr(s, 'note_moyenne').valeur }}</font> - ğŸ’° <font color="{{ get_c('prix_moyen') }}">{{ state_attr(s, 'prix_moyen').valeur }}</font><br>
                <b>Garde :</b> <font color="{{ get_c('garde_conseillee') }}">{{ state_attr(s, 'garde_conseillee').valeur }}</font>
                <b>ApogÃ©e :</b> <font color="{{ get_c('apogee') }}">{{ state_attr(s, 'apogee').valeur }}</font>
              {% else %}
                **Emplacement 20** :
                <font color="gray">*Emplacement Libre*</font>
              {% endif %}
          - type: entities
            entities:
              - entity: input_number.quantite_vin_20
                name: Nombre de bouteilles
                icon: mdi:counter
            show_header_toggle: false
            state_color: false
        grid_options:
          columns: 6
          rows: 8
