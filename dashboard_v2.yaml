views:
  - type: masonry
    path: cave
    title: Cave
    cards:
      - type: markdown
        title: üç∑ Mon Inventaire
        content: >
          {% set cave = state_attr('sensor.cave_a_vin_supersensor', 'vins') %}
          {% set year_now = now().year %}

          {%- macro get_status(raw_val) -%}
            {%- set n = (raw_val | replace('%', '') | int(0)) if raw_val is defined else 0 -%}
            {%- if n >= 95 -%} ‚úÖ
            {%- elif n >= 90 -%} üü¢
            {%- elif n >= 80 -%} üü°
            {%- elif n >= 60 -%} üü†
            {%- else -%} üî¥
            {%- endif -%}
          {%- endmacro -%}

          {% if cave is not none and cave.items() | count > 0 %}
            {% for id, info in cave.items() %}
            
            {% set c = (info.couleur.valeur | lower) if info.couleur is defined else '' %}
            {% set dot = 'üî¥' if 'rouge' in c else ('üåï' if 'blanc' in c else ('üèÆ' if 'ros' in c else '‚ö™')) %}
            {% set apo = (info.apogee.valeur | int(year_now)) if info.apogee is defined else year_now %}
            {% set apo_icon = '‚è≥' if apo > year_now else ('üíé' if apo == year_now else 'üçÇ') %}

            ---
            #### {{ dot }} {{ apo_icon }} **{{ info.nom.valeur }} ({{ info.annee.valeur }})**
            **Stock : {{ info.nombre_bouteilles | default(0) }} bouteille(s)**
            
            * {{ get_status(info.note.confiance) }} **Note :**  {{ info.note.valeur | default('N/A') }}
            * {{ get_status(info.prix_moyen.confiance) }} **Prix :** {{ info.prix_moyen.valeur | default('-') }} ‚Ç¨
            * {{ get_status(info.apogee.confiance) }} **Apog√©e :** {{ info.apogee.valeur | default('-') }}
            * {{ get_status(info.garde_conseillee.confiance) }} **Garde :** {{ info.garde_conseillee.valeur | default('-') }}
            
            *Appellation : {{ info.appellation.valeur | default('-') }} | {{ info.provenance.valeur | default('-') }}*
            <br><small>C√©pages : {{ info.cepages.valeur | default('-') }}</small>
            
            {% endfor %}
          {% else %}
            > ‚ÑπÔ∏è *La cave est vide.*
          {% endif %}
      - type: entities
        entities:
          - entity: sensor.cave_nombre_de_bouteilles
          - entity: sensor.cave_valeur_totale
          - entity: input_boolean.afficher_ajout_vin
          - entity: input_boolean.afficher_gestion_cave
          - entity: input_boolean.afficher_legende
      - type: markdown
        title: ‚ÑπÔ∏è L√©gende
        content: >
          **Confiance des donn√©es :** ‚úÖ >95% | üü¢ >90% | üü° >80% | üü† >60% | üî¥
          <60%

          **√âtat de consommation (Apog√©e) :** ‚è≥ Futur | üíé Ann√©e actuelle | üçÇ
          D√©pass√©

          **Codes couleurs vins :** üî¥ Rouge | üåï Blanc | üèÆ Ros√©
        visibility:
          - condition: state
            entity: input_boolean.afficher_legende
            state: 'on'
      - type: vertical-stack
        cards:
          - type: entities
            entities:
              - entity: input_text.v2_recherche_nom
              - entity: input_text.v2_recherche_couleur
              - entity: input_text.v2_recherche_annee
              - entity: input_button.v2_bouton_ia
                name: Rechercher le vin
              - entity: input_button.copy_vin_recherche_to_supersensor
                name: Ajouter le vin √† la cave
                action_name: Ajouter
                tap_action:
                  action: call-service
                  service: input_button.press
                  target:
                    entity_id: input_button.copy_vin_recherche_to_supersensor
          - type: vertical-stack
            cards:
              - type: markdown
                title: üîç √âtat de la recherche
                content: >
                  {% set r = states.sensor.vin_recherche.attributes %} {% set
                  err_msg = states('input_text.derniere_erreur_gemini') %}

                  {# Extraction s√©curis√©e #} {% set nom_attr = r.nom if r.nom is
                  defined else '{"valeur": "En attente"}' %} {% set nom_data =
                  nom_attr | from_json if nom_attr is string else nom_attr %} {%
                  set nom_r = nom_data.valeur | default('En attente') %}

                  {% set cave = state_attr('sensor.cave_a_vin_supersensor',
                  'vins') | default({}, true) %}

                  {# --- 1. GESTION DES ERREURS --- #}

                  {% if is_state('input_boolean.ia_erreur', 'on') %}
                    {% if '429' in err_msg %}
                      ## <font color="#e74c3c">‚ùå Quota IA d√©pass√© (429)</font>
                      Vous avez fait trop de requ√™tes. Attendez 1 minute avant de r√©essayer.
                    {% elif '503' in err_msg %}
                      ## <font color="#e74c3c">‚ùå Serveur IA surcharg√© (503)</font>
                      Google est temporairement satur√©. R√©essayez dans quelques instants.
                    {% else %}
                      ## <font color="#e74c3c">‚ùå Erreur d'IA</font>
                      Une erreur inattendue est survenue. Renouvelez votre recherche plus tard.
                    {% endif %}

                  {% elif is_state('input_boolean.ia_en_cours', 'on') %}
                    ## <font color="#3498db">üîÑ Recherche IA en cours...</font>
                    L'expert sommelier analyse votre demande.

                  {% elif nom_r == "En attente" %}
                    ## <font color="#7f8c8d">‚ö™ Pr√™t √† rechercher</font>
                    Remplissez les champs et lancez l'IA.

                  {% else %}
                    {# --- LOGIQUE DOUBLON --- #}
                    {% set annee_data = r.annee | from_json if r.annee is string else r.annee %}
                    {% set couleur_data = r.couleur | from_json if r.couleur is string else r.couleur %}
                    {% set annee_r = annee_data.valeur | string %}
                    {% set couleur_r = couleur_data.valeur | lower %}
                    
                    {% set ns = namespace(found=false) %}
                    {% for id, info in cave.items() %}
                      {% if info.nom.valeur | lower == nom_r | lower and 
                            info.annee.valeur | string == annee_r and 
                            info.couleur.valeur | lower == couleur_r %}
                        {% set ns.found = true %}
                      {% endif %}
                    {% endfor %}

                    {% if ns.found %}
                      ## <font color="#e67e22">‚ö†Ô∏è Vin d√©j√† existant</font>
                    {% else %}
                      ## <font color="#2ecc71">‚úÖ Vin trouv√©</font>
                    {% endif %}
                  {% endif %}

                  --- {# --- AFFICHAGE FICHE --- #} {% if nom_r != "En attente"
                  and is_state('input_boolean.ia_en_cours', 'off') and
                  is_state('input_boolean.ia_erreur', 'off') %} **D√©tails :** -
                  **Nom :** {{ nom_r }} - **Ann√©e :** {{ (r.annee | from_json if
                  r.annee is string else r.annee).valeur }} - **Prix estim√© :**
                  {{ (r.prix_moyen | from_json if r.prix_moyen is string else
                  r.prix_moyen).valeur }} ‚Ç¨ {% endif %}
        visibility:
          - condition: state
            entity: input_boolean.afficher_ajout_vin
            state: 'on'
      - type: vertical-stack
        cards:
          - type: vertical-stack
            cards:
              - type: entities
                title: ‚öôÔ∏è Outils de Gestion
                show_header_toggle: false
                entities:
                  - type: section
                    label: Modifier l'entr√©e s√©lectionn√©e
                  - entity: input_select.selection_vin_suppression
                    name: Choisir un vin
              - type: horizontal-stack
                cards:
                  - show_name: true
                    show_icon: true
                    type: button
                    name: Retrait bouteille
                    icon: mdi:minus-thick
                    tap_action:
                      action: call-service
                      service: input_button.press
                      target:
                        entity_id: input_button.decrement_stock
                    icon_height: 30px
                    show_state: false
                  - show_name: true
                    show_icon: true
                    type: button
                    name: Ajout bouteille
                    icon: mdi:plus-thick
                    tap_action:
                      action: call-service
                      service: input_button.press
                      target:
                        entity_id: input_button.increment_stock
                    icon_height: 30px
                  - show_name: true
                    show_icon: true
                    type: button
                    name: Supprimer
                    icon: mdi:delete-forever
                    tap_action:
                      action: call-service
                      service: input_button.press
                      target:
                        entity_id: input_button.delete_selected_wine
                    icon_height: 30px
              - type: markdown
                title: üìÑ D√©tails de l'entr√©e
                content: >
                  {% set selection =
                  states('input_select.selection_vin_suppression') %}  {% set
                  target_id = selection.split(' | ')[0] if '|' in selection else
                  '' %}  {% set cave =
                  state_attr('sensor.cave_a_vin_supersensor', 'vins') %}

                  {% if target_id in cave %}
                    {% set info = cave[target_id] %}
                    **Nom :** {{ info.nom.valeur }}
                    **Stock actuel : {{ info.nombre_bouteilles }} bouteilles**
                    
                    ---
                    **Fiche technique :**
                    - **Ann√©e :** {{ info.annee.valeur }}
                    - **Couleur :** {{ info.couleur.valeur }}
                    - **Appellation :** {{ info.appellation.valeur }}
                    - **Provenance :** {{ info.provenance.valeur }}
                    - **C√©pages :** {{ info.cepages.valeur }}
                    - **Note :** {{ info.note.valeur }}
                    - **Prix moyen :** {{ info.prix_moyen.valeur }} ‚Ç¨
                    - **Apog√©e :** {{ info.apogee.valeur }}
                    - **Garde :** {{ info.garde_conseillee.valeur }}
                    
                    <small>Identifiant technique : {{ target_id }}</small>
                  {% else %}
                    *Veuillez s√©lectionner un vin dans la liste d√©roulante pour voir sa fiche compl√®te.*
                  {% endif %}
        visibility:
          - condition: state
            entity: input_boolean.afficher_gestion_cave
            state: 'on'
